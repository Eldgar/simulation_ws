pipeline {
    agent any  // Use any available agent

    stages {
        stage('Setup Environment') {
            steps {
                sh '''
                # Source ROS Noetic and workspace
                source /opt/ros/noetic/setup.bash
                source ~/simulation_ws/devel/setup.bash
                
                echo "ROS environment set up."
                '''
            }
        }

        stage('Build Workspace') {
            steps {
                sh '''
                cd ~/simulation_ws
                '''
            }
        }

        stage('Launch Gazebo') {
            steps {
                sh '''
                # Start Gazebo in a screen session so it runs in the background
                screen -dmS gazebo_session roslaunch tortoisebot_gazebo tortoisebot_world.launch
                sleep 10
                echo "Gazebo started."
                '''
            }
        }

        stage('Run Waypoints Action Server Tests') {
            steps {
                sh '''
                roslaunch tortoisebot_waypoints waypoints_test.launch
                '''
            }
        }

        stage('Check Simulation Status') {
            steps {
                sh '''
                # Check if Gazebo is running
                if pgrep -x "gzserver" > /dev/null; then
                    echo "Gazebo is running."
                else
                    echo "Gazebo is NOT running."
                    exit 1
                fi
                '''
            }
        }

        stage('Cleanup') {
            steps {
                sh '''
                # Kill Gazebo processes after the test
                pkill -f gzserver || true
                pkill -f gzclient || true
                echo "Gazebo shut down."
                '''
            }
        }
    }

    triggers {
        pollSCM('H/4 * * * *')  // Poll GitHub for changes every 4 minutes
    }
}





