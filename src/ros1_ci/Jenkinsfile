pipeline {
    agent any
    stages {
        stage('Build Docker Image') {
            steps {
                sh '''
                cd $WORKSPACE/src/
                sudo docker build -t tortoisebot_ros1 .
                '''
            }
        }
        stage('Ensure Executable Permissions') {
            steps {
                sh '''
                echo "Setting executable permissions on Waypoints scripts..."
                chmod +x ~/simulation_ws/src/tortoisebot_waypoints/scripts/tortoisebot_action_server.py
                chmod +x ~/simulation_ws/src/tortoisebot_waypoints/test/waypoints_test.py
                echo "Executable permissions set."
                '''
            }
        }
        stage('Launch Simulation Container') {
            steps {
                sh '''
                echo "Stopping any existing simulation container..."
                sudo docker stop simulation_container || true
                sudo docker rm simulation_container || true

                echo "Launching simulation container with ROS Master, Gazebo, and Action Server..."
                sudo docker run -d --rm --name simulation_container \
                    -e ROS_MASTER_URI=http://localhost:11311 \
                    tortoisebot_ros1 \
                    bash -c "source /opt/ros/noetic/setup.bash && source ~/simulation_ws/devel/setup.bash && \
                             roscore > /dev/null 2>&1 & sleep 5 && \
                             echo 'roscore started' && \
                             roslaunch tortoisebot_gazebo tortoisebot_playground.launch --screen & sleep 10 && \
                             echo 'Gazebo launched, starting Action Server...' && \
                             rosrun tortoisebot_waypoints tortoisebot_action_server.py --screen && \
                             tail -f /dev/null"
                # Allow extra time for all nodes to initialize
                sleep 15
                '''
            }
        }
        stage('Run Waypoints Test on Host') {
            steps {
                sh '''
                echo "Running Waypoints Test on host..."
                source /opt/ros/noetic/setup.bash && source ~/simulation_ws/devel/setup.bash && \
                export ROS_MASTER_URI=http://localhost:11311 && \
                rostest tortoisebot_waypoints waypoints_test.test --reuse-master --text
                echo "Waypoints Test completed."
                '''
            }
        }
        stage('Cleanup') {
            steps {
                sh '''
                echo "Stopping simulation container..."
                sudo docker stop simulation_container || true
                echo "Cleanup complete."
                '''
            }
        }
    }
    triggers {
        // Poll the repository every 3 minutes.
        pollSCM('H/3 * * * *')
    }
}










